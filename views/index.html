<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visite e Medicine</title>
    <style>
        .header-top {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .header-top h2 {
            margin: 0;
            font-size: 20px;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .action-btn {
            background: #34495e;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
            margin: 2px;
        }

        .action-btn:hover {
            background: #2c3e50;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .user-info {
            font-size: 14px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="services.js"></script>
    <script>
        var arr;
        var med;
        var old = [];
        var tab = {};
        var tabMed = {};
        var pazienti = [];
        var medicine = [];
        var colonne;
        var righe;
        var doc;
        const { jsPDF } = window.jspdf;
        // VISITA CONTROLLER START
        const parseTime = async (str) => {
            const [h, min, s = 0] = str.split(":").map(Number);
            return h * 3600 + min * 60 + s; // converte tutto in secondi
        };

        const parseDate = async (dateStr) => {
            let [day, month, year] = dateStr.split('/');
            year = parseInt(year, 10) < 100 ? `20${year}` : year; // Gestisce l'anno con due cifre
            return new Date(year, month - 1, day); // Mese base 0 in JavaScript
        };

        var download = async (file) => {
            let now = new Date().toLocaleDateString('it-IT').replace(/\//g, '_');
            if (Object.keys(tab).length > 0) {
                Object.keys(tab).forEach(a => {
                    doc = new jsPDF();
                    colonne = [];
                    Object.values(tab[a]).forEach(b => {
                        Object.keys(b).forEach(c => {
                            c = c.replaceAll("_", " ");
                            if (!colonne.includes(c)) colonne.push(c);
                        });
                    });
                    righe = tab[a].map(obj => Object.values(obj));
                    if (file == "visite") {
                        righe.sort((a, b) => {
                            const parseDate = str => {
                                const [d, m, y] = str.split("/");
                                return new Date(`20${y}`, m - 1, d);
                            };

                            const parseTime = str => {
                                const [h, min, s = 0] = str.split(":").map(Number);
                                return h * 3600 + min * 60 + s; // converte tutto in secondi
                            };

                            const dataA = parseDate(a[1]);
                            const dataB = parseDate(b[1]);

                            if (dataA - dataB !== 0) {
                                return dataA - dataB; // confronto per data
                            } else {
                                //console.log("differenze orario a=> ", a[2], " b=>", b[2])
                                return parseTime(a[2]) - parseTime(b[2]); // confronto per ora
                            }
                        });
                    }
                    //console.log("colonne", colonne)
                    //console.log("righe dopo", righe)
                    doc.autoTable({
                        head: [colonne],
                        body: righe,
                        startY: 20,
                        pageBreak: 'avoid',
                        headStyles: { fontSize: 14 },
                        bodyStyles: { fontSize: 14 },
                        theme: 'grid'
                    });
                    doc.save(a + "_" + now + ".pdf");
                })
                // Log del download
                fetch('/api/log-action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'download', type: `${file} per paziente` })
                }).catch(err => console.error('Errore log:', err));
            } else if (arr.length > 0) {
                colonne = Object.keys(arr[0]).map(key => key.replaceAll("_", " "));
                righe = arr.map(obj => Object.values(obj));
                doc.autoTable({
                    head: [colonne],
                    body: righe,
                    startY: 20,
                    pageBreak: 'avoid',
                    headStyles: { fontSize: 14 },
                    bodyStyles: { fontSize: 14 },
                    theme: 'grid'
                });
                doc.save(arr[0].PAZIENTE + "_" + now + ".pdf");
                // Log del download
                fetch('/api/log-action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'download', type: file })
                }).catch(err => console.error('Errore log:', err));
            } else {
                console.log("Nessun paziente trovato");
                alert("Impossibile scaricare il nulla");
            }
        };

        var downloadAll = async (file) => {
            let now = new Date().toLocaleDateString('it-IT').replace(/\//g, '_');
            var doc = new jsPDF();

            if ((arr && Array.isArray(arr) && arr.length > 0) || (med && Array.isArray(med) && med.length > 0)) {
                if (file == "visite") {
                    // Colonne e righe dal file visite
                    colonne = Object.keys(arr[0]).map(key => key.replaceAll("_", " "));
                    righe = arr.map(obj => Object.values(obj));

                    // Funzioni locali per parsing (sincrone)
                    const parseDateLocal = (str) => {
                        if (!str) return new Date(0);
                        const parts = str.split('/');
                        if (parts.length < 3) return new Date(str);
                        let [d, m, y] = parts;
                        y = parseInt(y, 10);
                        if (y < 100) y = 2000 + y;
                        return new Date(y, parseInt(m, 10) - 1, parseInt(d, 10));
                    };

                    const parseTimeLocal = (str) => {
                        if (!str) return 0;
                        const parts = String(str).split(':').map(Number);
                        const h = parts[0] || 0;
                        const min = parts[1] || 0;
                        const s = parts[2] || 0;
                        return h * 3600 + min * 60 + s;
                    };

                    // Ordina per data crescente; per stessa data ordina per orario crescente
                    righe.sort((a, b) => {
                        const dateA = parseDateLocal(a[1]);
                        const dateB = parseDateLocal(b[1]);
                        if (dateA - dateB !== 0) return dateA - dateB;
                        // Stesso giorno -> confronto ora
                        return parseTimeLocal(a[2]) - parseTimeLocal(b[2]);
                    });
                } else if (file == "medicine") {
                    colonne = Object.keys(med[0]).map(key => key.replaceAll("_", " "));
                    righe = med.map(obj => Object.values(obj));
                }

                doc.autoTable({
                    head: [colonne],
                    body: righe,
                    startY: 20,
                    pageBreak: 'avoid',
                    headStyles: { fontSize: 14 },
                    bodyStyles: { fontSize: 14 },
                    theme: 'grid'
                });

                if (file == "visite") doc.save("visite_" + now + ".pdf");
                else if (file == "medicine") doc.save("medicine_" + now + ".pdf");
            } else {
                console.log("Nessun dato trovato");
                alert("Impossibile scaricare il nulla");
            }
        };

        var downloadMedicinePerPaziente = async () => {
            let now = new Date().toLocaleDateString('it-IT').replace(/\//g, '_');
            
            if (!tabMed || Object.keys(tabMed).length === 0) {
                alert("Nessuna medicina trovata");
                return;
            }

            Object.entries(tabMed).forEach(([paziente, medicines]) => {
                if (medicines.length === 0) return;
                
                const doc = new jsPDF();
                let yPos = 20;
                
                // Titolo con nome paziente
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(paziente, 20, yPos);
                
                yPos += 12;
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                
                // Raggruppa medicine per orario
                const orariOrder = ["colazione", "metà mattina", "pranzo", "metà pomeriggio", "cena"];
                const medicinePerOrario = {};
                
                // Inizializza gli orari
                orariOrder.forEach(orario => {
                    medicinePerOrario[orario] = [];
                });
                
                // Organizza medicine per orario
                medicines.forEach(medicine => {
                    const ora = (medicine.ORA || medicine.ora || "").toLowerCase();
                    if (medicinePerOrario[ora]) {
                        medicinePerOrario[ora].push(medicine);
                    } else if (ora) {
                        medicinePerOrario[ora] = [medicine];
                    }
                });
                
                // Stampa medicine organizzate per orario
                orariOrder.forEach(orario => {
                    if (medicinePerOrario[orario].length > 0) {
                        // Titolo orario
                        doc.setFont(undefined, 'bold');
                        doc.text(orario.toUpperCase() + ":", 20, yPos);
                        yPos += 8;
                        doc.setFont(undefined, 'normal');
                        
                        // Medicine per questo orario
                        medicinePerOrario[orario].forEach(medicine => {
                            let medicineText = "- " + (medicine.MEDICINA || medicine.medicina || "").toUpperCase();
                            if (medicine.GIORNO || medicine.giorno) medicineText += " (" + (medicine.GIORNO || medicine.giorno) + ")";
                            if (medicine.NOTE || medicine.note) medicineText += " - " + (medicine.NOTE || medicine.note);
                            
                            const lines = doc.splitTextToSize(medicineText, 170);
                            doc.text(lines, 25, yPos);
                            yPos += lines.length * 6;
                            
                            // Pagina nuova se necessario
                            if (yPos > 270) {
                                doc.addPage();
                                yPos = 20;
                            }
                        });
                        
                        yPos += 3; // Spazio tra orari
                    }
                });
                
                doc.save(paziente + "_medicine_" + now + ".pdf");
            });

            // Log del download
            fetch('/api/log-action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'download', type: 'medicine' })
            }).catch(err => console.error('Errore log:', err));
        };
        // VISITA CONTROLLER END
        var addForm = async () => {
            let formContainer = document.getElementById("formContainer");
            let originalForm = document.querySelector(".dynamic-form");
            let newForm = originalForm.cloneNode(true); // Clona la form esistente

            // Resetta i valori dei campi nella nuova form
            newForm.querySelector(".paziente").value = "";
            newForm.querySelector(".data").value = "";
            newForm.querySelector(".ora").value = "";
            newForm.querySelector(".luogo").value = "";
            newForm.querySelector(".tipoVisita").value = "";
            newForm.querySelector(".note").value = "";

            formContainer.appendChild(newForm); // Aggiunge la nuova form alla pagina
        };

        var addFormMedicina = async () => {
            let formContainer = document.getElementById("formContainer");
            let originalForm = document.querySelector(".dynamic-form");
            let newForm = originalForm.cloneNode(true); // Clona la form esistente

            // Resetta i valori dei campi nella nuova form
            newForm.querySelector(".paziente").value = "";
            newForm.querySelector(".medicina").value = "";
            newForm.querySelector(".giorno").value = "";
            newForm.querySelector(".ora").value = "";
            newForm.querySelector(".note").value = "";

            formContainer.appendChild(newForm); // Aggiunge la nuova form alla pagina
        };

        var aggiungiMedicina = async (event) => {
            event.preventDefault();
            let formMedicine = document.querySelectorAll(".form-medicine");

            for (let form of formMedicine) {
                var paziente = form.querySelector(".paziente").value;
                var medicina = form.querySelector(".medicina").value.toUpperCase();
                var giorno = form.querySelector(".giorno").value;
                var ora = form.querySelector(".ora").value;
                var note = form.querySelector(".note").value;

                if (!paziente && !medicina && !giorno && !ora && !note) {
                    continue; // Salta i form vuoti
                }

                const medicinaData = {
                    paziente: paziente,
                    medicina: medicina.toUpperCase(),
                    giorno: giorno,
                    ora: ora,
                    note: note
                };

                try {
                    const result = await apiService.aggiungiMedicina(medicinaData);
                    if (result.success) {
                        form.reset();
                    } else {
                        alert("Errore: " + result.error);
                    }
                } catch (error) {
                    console.error("Errore:", error);
                    alert("Errore nell'aggiunta della medicina");
                }
            }

            await leggiMedicine();
        };
        var aggiungiVisita = async (event) => {
            event.preventDefault();
            let formVisite = document.querySelectorAll(".form-visite");

            for (let form of formVisite) {
                let paziente = form.querySelector(".paziente").value;
                let data = form.querySelector(".data").value;
                let ora = form.querySelector(".ora").value;
                let luogo = form.querySelector(".luogo").value;
                let tipoVisita = form.querySelector(".tipoVisita").value;
                let note = form.querySelector(".note").value;

                if (!paziente && !data && !ora && !luogo && !tipoVisita && !note) {
                    continue; // Salta i form vuoti
                }

                const visita = {
                    paziente: paziente,
                    data: data,
                    ora: ora,
                    luogo: luogo,
                    tipoVisita: tipoVisita,
                    note: note
                };

                try {
                    const result = await apiService.aggiungiVisita(visita);
                    if (result.success) {
                        form.reset();
                    } else {
                        alert("Errore: " + result.error);
                    }
                } catch (error) {
                    console.error("Errore:", error);
                    alert("Errore nell'aggiunta della visita");
                }
            }

            await leggiVisite();
        };

        var createTableFromArray = async (ar) => {
            const tableContainer = document.getElementById("tableContainer");
            tableContainer.innerHTML = ""; // Svuota il contenitore

            if (!ar || !Array.isArray(ar) || ar.length === 0) {
                // Mostra messaggio se file vuoto
                const emptyMsg = document.createElement("div");
                emptyMsg.style.cssText = "text-align: center; padding: 40px; font-size: 18px; color: #999;";
                emptyMsg.textContent = "Non ci sono ancora dati salvati.";
                tableContainer.appendChild(emptyMsg);
                return;
            }

            var table = document.createElement("table");
            var thead = document.createElement("thead");
            var tbody = document.createElement("tbody");

            // Aggiungi intestazioni
            var headers = Object.keys(ar[0]);
            headers.push("Azioni"); // Aggiungi colonna azioni
            var headerRow = document.createElement("tr");
            headers.forEach(header => {
                var th = document.createElement("th");
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Aggiungi righe di dati
            ar.forEach((row, index) => {
                var dataRow = document.createElement("tr");
                Object.keys(ar[0]).forEach(header => {
                    var td = document.createElement("td");
                    td.textContent = row[header];
                    dataRow.appendChild(td);
                });
                
                // Aggiungi bottone elimina
                var actionTd = document.createElement("td");
                var deleteBtn = document.createElement("button");
                deleteBtn.textContent = "✕";
                deleteBtn.style.cssText = "background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-weight: bold;";
                deleteBtn.onclick = () => eliminaVoce(ar, index);
                actionTd.appendChild(deleteBtn);
                dataRow.appendChild(actionTd);
                
                tbody.appendChild(dataRow);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
            tableContainer.appendChild(table);
        }

        var checkDate = async (arr) => {
            try {
                const result = await apiService.pulisciDate(arr);
                if (result.success) {
                    alert("Date vecchie pulite e salvate!");
                    await leggiVisite();
                } else {
                    alert("Errore: " + result.error);
                }
            } catch (error) {
                console.error("Errore nella pulizia delle date:", error);
                alert("Errore nella pulizia delle date");
            }
        }
        /*        var leggiOld = async () => {
                                fetch("/api/readstorico", {
                                    method: "GET",
                                    headers: { "Content-Type": "application/json" }
                                })
                                    .then(response => response.text())
                                    .then(data => { oldFile = data })
                                    .catch(err => console.error("Errore:", err));
                };
                            */

        var leggiVisite = async () => {
            try {
                arr = await apiService.leggiVisite();
                tab = await apiService.organizzaVisite();

                if (arr && Array.isArray(arr) && arr.length > 0) {
                    if (Object.keys(tab).length == 1) {
                        await createTableFromArray(arr);
                    } else {
                        await createTables(tab, 'visita');
                    }
                } else {
                    console.log("file vuoto");
                    alert("Nessuna visita trovata");
                }
            } catch (err) {
                console.error("Errore durante la lettura del file:", err);
                alert("Errore nella lettura del file");
            }
        };

        var leggiMedicine = async () => {
            try {
                med = await apiService.leggiMedicine();
                tabMed = await apiService.organizzaMedicine();

                if (med && Array.isArray(med) && med.length > 0) {
                    if (Object.keys(tabMed).length == 1) {
                        await createTableFromArray(med);
                    } else {
                        await createTables(tabMed, 'medicina');
                    }
                } else {
                    console.log("file vuoto");
                    alert("Nessuna medicina trovata");
                }
            } catch (err) {
                console.error("Errore durante la lettura del file:", err);
                alert("Errore nella lettura del file");
            }
        };

        var createTables = async (tab, tipo) => {
            const container = document.getElementById('tableContainer');
            container.innerHTML = ""; // Svuota il contenitore

            let hasData = false;
            Object.entries(tab).forEach(([key, array]) => {
                if (array.length === 0) return;
                hasData = true;

                const table = document.createElement("table");
                const thead = document.createElement("thead");
                const tbody = document.createElement("tbody");

                // Aggiungi intestazioni
                const headers = Object.keys(array[0]);
                headers.push("Azioni"); // Aggiungi colonna azioni
                const headerRow = document.createElement("tr");
                headers.forEach(header => {
                    const th = document.createElement("th");
                    th.textContent = header.replaceAll("_", " ");
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                // Aggiungi righe di dati
                array.forEach((row, index) => {
                    const dataRow = document.createElement("tr");
                    Object.keys(array[0]).forEach(header => {
                        const td = document.createElement("td");
                        td.textContent = row[header];
                        dataRow.appendChild(td);
                    });
                    
                    // Aggiungi bottone elimina
                    const actionTd = document.createElement("td");
                    const deleteBtn = document.createElement("button");
                    deleteBtn.textContent = "✕";
                    deleteBtn.style.cssText = "background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-weight: bold;";
                    deleteBtn.onclick = () => eliminaVocePerPaziente(key, index, tipo);
                    actionTd.appendChild(deleteBtn);
                    dataRow.appendChild(actionTd);
                    
                    tbody.appendChild(dataRow);
                });

                table.appendChild(thead);
                table.appendChild(tbody);
                container.appendChild(table);
            });

            // Se non c'è nessun dato, mostra messaggio
            if (!hasData) {
                const emptyMsg = document.createElement("div");
                emptyMsg.style.cssText = "text-align: center; padding: 40px; font-size: 18px; color: #999;";
                emptyMsg.textContent = "Non ci sono ancora dati salvati.";
                container.appendChild(emptyMsg);
            }
        }

        // Funzione per eliminare una voce da una tabella con più pazienti
        var eliminaVocePerPaziente = async (paziente, index, tipo) => {
            if (confirm("Sei sicuro di voler eliminare questa voce?")) {
                try {
                    const result = await apiService.eliminaVoce(tipo, paziente, index);
                    if (result.success) {
                        if (tipo === 'visita') {
                            await leggiVisite();
                        } else if (tipo === 'medicina') {
                            await leggiMedicine();
                        }
                    } else {
                        alert("Errore: " + result.error);
                    }
                } catch (error) {
                    console.error("Errore nell'eliminazione:", error);
                    alert("Errore nell'eliminazione della voce");
                }
            }
        }

        // Funzione per eliminare una voce
        var eliminaVoce = async (array, index) => {
            if (confirm("Sei sicuro di voler eliminare questa voce?")) {
                // Determina il tipo (visite o medicine)
                const isVisite = arr && arr === array;
                const tipo = isVisite ? "visita" : "medicina";
                
                // Prendi il paziente dalla voce da eliminare
                const voce = array[index];
                const paziente = voce.PAZIENTE;
                
                try {
                    const result = await apiService.eliminaVoce(tipo, paziente, index);
                    if (result.success) {
                        if (isVisite) {
                            await leggiVisite();
                        } else {
                            await leggiMedicine();
                        }
                    } else {
                        alert("Errore: " + result.error);
                    }
                } catch (error) {
                    console.error("Errore nell'eliminazione:", error);
                    alert("Errore nell'eliminazione della voce");
                }
            }
        }

        var mostraVisite = async () => {
            document.getElementById('formVisite').style.display = 'block';
            document.getElementById('formMedicine').style.display = 'none';
            document.getElementById('checkDate').style.display = 'inline-block'; // Mostra pulisci date
            
            // Nascondi il bottone salva medicine
            const saveMedBtn = document.getElementById('saveMed');
            if (saveMedBtn) saveMedBtn.style.display = 'none';
        }

        var mostraMedicine = async () => {
            document.getElementById('formVisite').style.display = 'none';
            document.getElementById('formMedicine').style.display = 'block';
            document.getElementById('checkDate').style.display = 'none'; // Nascondi pulisci date
        }

    </script>
    <style>
        .table-form {
            border-collapse: collapse;
            margin-top: 1px;
            background-color: #f8f9fa;
            font-size: 16px;
            width: 100%;

            td {
                padding: 6px;
                border: 1px solid #e0e0e0;
            }

            td:first-child {
                font-weight: 600;
                color: #667eea;
                width: 40%;
                background-color: #f0f2ff;
            }

            input,
            select,
            textarea {
                width: 100%;
                padding: 5px;
                box-sizing: border-box;
                font-size: 15px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-family: inherit;
            }

            input:focus,
            select:focus,
            textarea:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
        }

        .leggi {
            flex: none;
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
        }

        .sinistra {
            background-color: #ffffff;
            width: 80%;
            color: white;
            font-size: 24px;

            .alto {
                height: 15%;
                background-color: #ffffff;
                align-items: center;
                justify-content: center;
                color: black;
            }

            ;

            .basso {
                height: 85%;
                background-color: #ffffff;
                align-items: center;
                justify-content: center;
                color: black;
            }
        }

        .destra {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 30%;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            color: white;
            font-size: 15px;
            margin: 10px;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            border-radius: 10px;
        }

        .destra::-webkit-scrollbar {
            width: 8px;
        }

        .destra::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .destra::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        .destra::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .form-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 10px;
            color: #333;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
        }

        .form-section h1 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #667eea;
            font-size: 24px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-section .action-btn {
            display: block;
            width: 100%;
            margin: 8px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .form-section .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .form-section .action-btn:active {
            transform: translateY(0);
        }

        table {
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 25px;

            th,
            td {
                border: 1px solid #ddd;
                padding: 12px;
                text-align: center;
            }

            th {
                background-color: #f4f4f4;
            }

            tr:nth-child(even) {
                background-color: #f9f9f9;
            }

            tr:hover {
                background-color: #f1f1f1;
            }

            .form-section {
                transition: opacity 0.3s ease;
            }

        }
    </style>
</head>

<body>
    <div class="sinistra">
        <div class="header-top" class="alto" style="display: flex; gap: 15px; align-items: center;">
            <h1>Casa Chiesa
                <button type="button" class="action-btn" onclick="leggiVisite(), mostraVisite()">Leggi visite</button>
                <button type="button" class="action-btn" onclick="leggiMedicine(), mostraMedicine()">Leggi medicine</button>
                <button id="checkDate" class="action-btn" onclick="checkDate(arr)" style="display: none;">Pulisci date vecchie e Salva</button>
                <span class="user-info" id="userInfo">Utente: <strong id="currentUser">-</strong></span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </h1>
        </div>
        <div class="basso">
            <pre id="tableContainer"></pre>
        </div>
    </div>

    <div class="destra">
        <!-- Form VISITE -->
        <div id="formVisite" class="form-section">
            <h1>VISITE</h1>
            <!--<button type="button" onclick="addForm()">Aggiungi righe</button> -->
            <button type="submit" class="action-btn" onclick="aggiungiVisita(event)">Salva</button>
            <button class="action-btn" onclick="download('visite')">Scarica separati</button>
            <button class="action-btn" onclick="downloadAll('visite')">Scarica insieme</button>
            <form class="dynamic-form form-visite">
                <table class="table-form">
                    <tr>
                        <td> <label for="paziente">Paziente</label> </td>
                        <td> <input type="text" class="paziente" name="paziente" required> </td>
                    </tr>
                    <tr>
                        <td> <label for="data">Data</label> </td>
                        <td> <input type="date" class="data" name="data" required> </td>
                    </tr>
                    <tr>
                        <td> <label for="ora">Ora</label> </td>
                        <td> <input type="text" class="ora" name="ora" required> </td>
                    </tr>
                    <tr>
                        <td> <label for="luogo">Luogo</label> </td>
                        <td> <input type="text" class="luogo" name="luogo" required> </td>
                    </tr>
                    <tr>
                        <td> <label for="tipoVisita">Tipo Visita</label> </td>
                        <td> <input type="text" class="tipoVisita" name="tipoVisita" required> </td>
                    </tr>
                    <tr>
                        <td> <label for="note">Note</label> </td>
                        <td> <input type="text" class="note" name="note"> </td>
                    </tr>
                </table>
            </form>
            <form class="dynamic-form form-visite">
                <table class="table-form">
                    <tr>
                        <td> <label for="paziente">Paziente</label> </td>
                        <td> <input type="text" class="paziente" name="paziente" required> </td>
                    </tr>
                    <tr>
                        <td> <label for="data">Data</label> </td>
                        <td> <input type="date" class="data" name="data" required> </td>
                    </tr>
                    <tr>
                        <td> <label for="ora">Ora</label> </td>
                        <td> <input type="text" class="ora" name="ora" required> </td>
                    </tr>
                    <tr>
                        <td> <label for="luogo">Luogo</label> </td>
                        <td> <input type="text" class="luogo" name="luogo" required> </td>
                    </tr>
                    <tr>
                        <td> <label for="tipoVisita">Tipo Visita</label> </td>
                        <td> <input type="text" class="tipoVisita" name="tipoVisita" required> </td>
                    </tr>
                    <tr>
                        <td> <label for="note">Note</label> </td>
                        <td> <input type="text" class="note" name="note"> </td>
                    </tr>
                </table>
            </form>
        </div>

        <!-- Form MEDICINE -->
        <div id="formMedicine" class="form-section" style="display:none;">
            <h1>MEDICINE</h1>
            <!-- <button type="button" onclick="addFormMedicina()">Aggiungi righe</button> -->
            <button type="submit" class="action-btn" onclick="aggiungiMedicina(event)">Salva</button>
            <button class="action-btn" onclick="downloadMedicinePerPaziente()">Scarica</button>

            <form class="dynamic-form form-medicine">
                <table class="table-form">
                    <tr>
                        <td> <label for="paziente">Paziente</label> </td>
                        <td> <input type="text" class="paziente" name="paziente" required> </td>
                    </tr>
                    <tr>
                        <td> <label for="medicina">Medicina</label> </td>
                        <td> <input type="text" class="medicina" name="medicina" required> </td>
                    </tr>
                    <tr>
                        <td> <label for="giorno">Data</label> </td>
                        <td> <select class="giorno" name="giorno" required> </select></td>
                    </tr>
                    <tr>
                        <td> <label for="ora">Ora</label> </td>
                        <td> <select class="ora" name="ora" required> </select></td>
                    </tr>
                    <tr>
                        <td> <label for="note">Note</label> </td>
                        <td> <input type="text" class="note" name="note"> </td>
                    </tr>
                </table>
                <script>
                    // --- SELEZIONI ---
                    var giorniSelects = document.querySelectorAll('.giorno');
                    var oraSelects = document.querySelectorAll('.ora');

                    // Definisci giorni e orari secondo l'ordinamento
                    const giorni = ["tutti i giorni", "giorni alterni", "lunedì", "martedì", "mercoledì", "giovedì", "venerdì", "sabato", "domenica"];
                    const orari = ["colazione", "metà mattina", "pranzo", "metà pomeriggio", "cena"];

                    // Popola tutti i select dei giorni
                    giorniSelects.forEach(giornoSelect => {
                        giorni.forEach(g => {
                            var option = document.createElement('option');
                            option.value = g;
                            option.textContent = g;
                            giornoSelect.appendChild(option);
                        });
                    });

                    // Popola tutti i select dell'ora
                    oraSelects.forEach(oraSelect => {
                        orari.forEach(o => {
                            var option = document.createElement('option');
                            option.value = o;
                            option.textContent = o;
                            oraSelect.appendChild(option);
                        });
                    });
                </script>
            </form>
        </div>
    </div>

    <script>
        // Carica il nome utente dal session storage
        function loadUserInfo() {
            const user = sessionStorage.getItem('currentUser');
            if (user) {
                document.getElementById('currentUser').textContent = user;

                // Mostra il bottone checkDate solo se l'utente NON è "test"
                if (user !== 'test') {
                    document.getElementById('checkDate').style.display = 'inline-block';
                }
            }
        }

        // Funzione logout
        function logout() {
            if (confirm('Sei sicuro di voler uscire?')) {
                window.location.href = '/logout';
            }
        }

        // Assicura che gli input date siano interattivi su tutti i browser
        function attachDatePickers() {
            const dateInputs = document.querySelectorAll('input[type="date"].data');
            dateInputs.forEach(input => {
                // Stile per evitare che vengano coperti da overlay
                input.style.position = 'relative';
                input.style.zIndex = 9999;
                input.style.cursor = 'pointer';

                // Alcuni browser supportano showPicker() per aprire il calendario
                const openPicker = () => { if (typeof input.showPicker === 'function') input.showPicker(); };

                input.addEventListener('click', openPicker);
                input.addEventListener('focus', openPicker);
            });
        }

        // Carica le informazioni utente e inizializza i date pickers al caricamento
        window.addEventListener('load', () => { loadUserInfo(); attachDatePickers(); });
    </script>

</body>

</html>